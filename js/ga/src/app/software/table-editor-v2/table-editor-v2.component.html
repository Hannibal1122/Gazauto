<div class="tableGrid" [class.tableGridWidthHeaderEditor] = "headerEditorShow">
    <div name = "clickArea" class = "tableControlPanel">
        <div class = "nameTableClass" 
            title="{{nameTable}}">
            {{nameTable}}
            <div style="position:relative; width:170px; height:6px; border-radius:3px;" class = "substrate">
                <div style="position:absolute; top:0px; height:6px; left:0px; border-radius:3px;" 
                    [style.width] = "control.state + '%'"
                    [class.tableCellStateGreen] = "control.state == 100"
                    [class.tableCellStateYellow] = "control.state >= 50 && control.state < 100"
                    [class.tableCellStateRed] = "control.state < 50">
                </div>
                <div style="position:absolute; right:-25px; top: -4px; font-size: 11px; font-weight: bold;" class = "TableCreatorHeadColor">{{control.state + '%'}}</div>
            </div>
        </div>
        <button class = "mainButton" [class.enableButton] = "headerEditorShow" title = "Заголовок" (click) = "changeHeader()"><i class="fas fa-heading"></i></button>
        <button class = "mainButton" title = "Экспорт в Excel" (click) = "exportToExcel()" ><i class="fas fa-file-excel"></i></button>
        <button class = "mainButton" title = "Импорт таблицы" (click) = "importFromExcel()" [disabled] = "!right.change"><i class="fas fa-download"></i></button>
        <button class = "mainButton" title = "Добавить строку" (click) = "addRow('end', 1)" [disabled] = "!right.change"><i class="fas fa-plus"></i></button>
        <button class = "mainButton" [class.enableButton] = "tableProperty.visible" title = "Таблица свойств" (click) = "openTableProperty()"><i class="fas fa-briefcase"></i></button>
        <button class = "mainButton" title = "Сохраненная позиция" (click) = "loadTableProperty('scroll')"><i class="fas fa-bookmark"></i></button>
        <button class = "mainButton" [class.enableButton] = "tableFilter.enable" title = "Включить фильтры" (click) = "enableFilters()"><i class="fa fa-filter"></i></button>
        <button class = "mainButton" [class.enableButton] = "lineNumbering.enable" title = "Нумерация строк" (click) = "enableLineNumbering()"><i class="fas fa-list-ol"></i></button>
        <button class = "mainButton" (click) = "loadTable()" title = "Обновить"><i class="fas fa-sync-alt"></i></button>
        <select class = "mainSelect"
            style = "margin-left: 2px; height: 32px; cursor:pointer;" 
            [(ngModel)] = "filter.selected"
            (change) = "onFilterChange()">
            <option *ngFor = "let o of filter.list" [value] = "o.id">{{ o.value }}</option>
        </select>
    </div>
    <app-table-header-editor *ngIf = "headerEditorShow" [tableId] = "id" [header] = "dataHeader" [disabled] = "!right.change || !right.head" (updateTable) = "updateEventFromHeader($event)"></app-table-header-editor>
    <div name = "clickArea" #mainContainer 
        class = "MainBColor"
        style = "overflow: auto; position: relative;"
        (scroll) = "saveScroll()">
        <table class = "errorTable TableCreatorBorderColor" (click) = "editField($event)">
            <tr>
                <th 
                    name = "clickArea"  
                    *ngIf = "lineNumbering.enable"
                    class = "TableCreatorHeadColor TableCreatorHeadBColor"></th>
                <ng-container *ngFor = "let head of dataHeader; let i = index;">
                    <th *ngIf = "head && hiddenColumn[i] !== true"
                        name = "clickArea"  
                        class = "TableCreatorHeadColor TableCreatorHeadBColor" 
                        id = "{{ head.id }}"
                        (click) = "onChangeSort(i)"
                        (contextmenu) = "getContextmenu($event, i, 'head')">
                        {{ head.name }}
                        <span *ngIf = "sortProperty.column == i && head.sort">
                            <i class="fas fa-long-arrow-alt-up"></i>
                        </span>
                        <span *ngIf = "sortProperty.column == i && !head.sort">
                            <i class="fas fa-long-arrow-alt-down"></i>
                        </span>
                        <div class="linkClass">
                            <span *ngIf = "head.dataType == 'NUMBER'" class = "linkValueClass" style = "padding-left: 3px; padding-right: 4px;">123</span>
                            <span *ngIf = "head.dataType == 'STRING'" class = "linkValueClass" style = "padding-left: 2px; padding-right: 2px;">str</span>
                            <span *ngIf = "head.dataType == 'DATETIME'" class = "linkValueClass">
                                <i class="fas fa-clock"></i>
                            </span>
                            <span *ngIf = "head.dataType == 'tlist'" class = "linkValueClass">
                                <i class="fas fa-bars"></i>
                            </span>
                            <span *ngIf = "head.eventId" class = "linkCellClass">
                                <i class = "fa fa-bolt"></i>
                            </span>
                        </div>
                    </th>
                </ng-container>
            </tr>
            <tr *ngIf = "tableFilter.enable">
                <td *ngIf = "lineNumbering.enable" style = "padding:0px;" class = "TableCreatorHeadColor TableCreatorHeadBColor"></td>
                <ng-container *ngFor = "let filter of tableFilter.fields; let i = index;">
                    <td *ngIf = "filter && hiddenColumn[i] !== true" style = "padding:0px;">
                        <select [(ngModel)] = "filter.sign" 
                            style = "width:40px; height:22px; float:left;"
                            (change) = "onChangeFilter(i)">
                            <option>=</option>
                            <option>!=</option>
                            <option>*</option>
                            <option>!*</option>
                        </select>
                        <input type = "text" 
                            style = "width: calc(100% - 40px); height:22px; border:1px solid transparent; padding:5px;" 
                            placeholder="Поиск"
                            [(ngModel)] = "filter.value"
                            (input) = "onChangeFilter(i, $event.target.value)">
                    </td>
                </ng-container>
            </tr>
            <tr *ngIf = "tableFilter.enable">
                <td *ngIf = "lineNumbering.enable" style = "padding:0px;" class = "TableCreatorHeadColor TableCreatorHeadBColor"></td>
                <ng-container *ngFor = "let filter of tableFilter.state; let i = index;">
                    <td *ngIf = "filter && hiddenColumn[i] !== true" style = "padding:0px;">
                        <select [(ngModel)] = "filter.sign" 
                            style = "width:40px; height:22px; float:left;"
                            (change) = "onChangeFilter(i)">
                            <option>=</option>
                            <option>!=</option>
                            <option>></option>
                            <option>>=</option>
                            <option><</option>
                            <option><=</option>
                        </select>
                        <input type = "text" 
                            style = "width: calc(100% - 40px); height:22px; border:1px solid transparent; padding:5px;" 
                            placeholder="Статус"
                            [(ngModel)] = "filter.value"
                            (input) = "onChangeFilterState(i, $event.target.value)">
                    </td>
                </ng-container>
            </tr>
            <ng-container *ngFor = "let row of dataTable; let i = index;">
                <tr *ngIf = "!tableFilter.mapHideRows[i]">
                    <td *ngIf = "lineNumbering.enable"
                        (contextmenu) = "getContextmenu($event, i, 'row')" 
                        [class.cutRow] = "cutCopyRowProperty.i == i"
                        class = "TableCreatorHeadColor TableCreatorHeadBColor">{{ i + 1 }}</td>
                    <ng-container *ngFor = "let cell of row; let j = index;">
                        <td *ngIf = "cell && hiddenColumn[j] !== true" 
                            id = "{{ cell.id }}"
                            (contextmenu) = "getContextmenu($event, i, 'cell')"
                            [style.background] = "cell.id == searchCellId ? '#e7f5c6' : (cell.id == inputProperty._colorId ? '#9abfe225' : cell.color)">
                            {{ cell && cell.listValue ? cell.listValue : cell.value }}
                            <div class="linkClass">
                                <span *ngIf = "(cell.type == 'tlist')" class = "linkCellClass">
                                    <i class="fas fa-bars"></i>
                                </span>
                                <span *ngIf = "cell.type == 'table'" class = "linkValueClass">
                                    <i class = "fa fa-table"></i>
                                </span>
                                <span *ngIf = "cell.type == 'cell'" class = "linkCellClass" [class.linkErrorClass] = "cell.value == null">
                                    <i class = "fa fa-link"></i>
                                </span>
                                <span *ngIf = "cell.type == 'file'" class = "linkValueClass">
                                    <i class = "fa fa-file"></i>
                                </span>
                                <span *ngIf = "cell.eventId" class = "linkCellClass" (dblclick) = "openEventToExplorer(cell.eventId)">
                                    <i class = "fa fa-bolt"></i>
                                </span>
                            </div>
                            <div style = "position:absolute; pointer-events:none; width:100%; height:100%; top:0px; left:0px;">
                                <div *ngIf = "cell.state" [style.width] = "cell.state + '%'" class = "tableStateLoading" 
                                    [class.tableCellStateGreen] = "cell.state == 100"
                                    [class.tableCellStateYellow] = "cell.state >= 50 && cell.state < 100"
                                    [class.tableCellStateRed] = "cell.state < 50">
                                </div>
                            </div>
                        </td>
                    </ng-container>
                </tr>
            </ng-container>
        </table>
        <div style = "position:absolute;" [ngStyle] = "configInput" [hidden] = "!inputProperty.visible">
            <textarea #mainInputElement class = "mainInputStyle TableCreatorInputColor" 
                [hidden] = "inputProperty.type == 'tlist' || inputProperty.type == 'datetime'" 
                (blur) = "acceptEditField()" 
                [(ngModel)] = "inputProperty.value" 
                (keydown)="downEnter($event)"></textarea>
            <button *ngIf = "inputProperty.type == 'table'"
                style = "position:absolute; right:0px; top: 0px; color:red; cursor:pointer; border:none; background:none; outline: none;">
                <i class = "fa fa-times-circle"></i>
            </button>
            <ng-container *ngIf = "inputProperty.type == 'tlist'" >
                <textarea class = "mainInputStyle TableCreatorInputColor" 
                    [(ngModel)] = "inputProperty.value" 
                    (keydown)="downEnter($event)"></textarea>
                <select (change) = "changeMainSelect()"
                    style = "position:absolute; top: 100%; height: 24px; width:100%;" 
                    [(ngModel)] = "inputProperty.valueList">
                    <option *ngFor = "let option of inputProperty.values" value = "{{ option.id }}">{{ option.value }}</option>
                </select>
            </ng-container>
        </div>
        <div [hidden] = "!tableProperty.visible" 
            [ngStyle] = "{ transform: tableProperty.translate }"
            class = "tableProperty"> 
            <div style = "width:100%; height:50%; overflow: auto; display: flex; flex-wrap: wrap; position: relative;">
                <div *ngIf = "!tableProperty.listLink.visible" (click) = "getListLink()" class = "wordCenter">Показать связи</div>
                <ng-container *ngIf = "tableProperty.listLink.visible">
                    <div *ngIf = "tableProperty.listLink.empty" class = "wordCenter">Связи отсутсвуют</div>
                    <div *ngIf = "tableProperty.listLink.whoRefer.length != 0">
                        <div style = "font-size:16px; font-weight:bold;">Объект используется:</div>
                        <div *ngFor = "let field of tableProperty.listLink.whoRefer" class = "linkField" (click) = "openToExplorer({ type: 'cell', linkId: field })">
                            <i class="fas fa-cube"></i> Ячейка {{ field }}
                        </div>
                    </div>
                </ng-container>
            </div>
            <app-table-property #appTableProperty [mainDataField] = "tableProperty.data" [rules] = "tableProperty.rules" (onSave) = "updateCell($event)"></app-table-property>
            <div class = "ModalButtonExitColor" style = "position:absolute; right:5px; top:5px; font-size:16px; cursor:pointer;" (click) = "closeTableProperty()">
                <i class="fas fa-times-circle"></i>
            </div>
        </div>
    </div>
    <div name = "clickArea">
        <div class = "bottomControlPanel TableCreatorHeadColor">
            <div *ngIf = "control.error" style = "font-size:12px; background-color:#af7e7e; color:white; font-weight:bold;">Таблица не доступна!</div>
            <div *ngIf = "loaded && !control.error && dataHeader.length == 0" style = "font-size:12px; background-color:#b8b8b8; color:white; font-weight:bold;">Таблица пуста</div>
            <div *ngIf = "loaded && !control.error && needUpdate" style = "font-size:12px; background-color:#b8b8b8; color:white; font-weight:bold;">Требуется синхронизация</div>
            <div *ngIf = "!loaded" style = "font-size:12px; background-color:#b8b8b8; color:white; font-weight:bold;">Загрузка...</div>
            <div *ngIf = "tableFilter.countHide > 0" class = "PanelAppColor" style = "font-size:12px; color:white;">Показано: {{ tableFilter.count - tableFilter.countHide}} из {{ tableFilter.count }}</div>
        </div>
        <div class = "bottomControlPanel right">
            <div *ngFor = "let login of listLogin" class = "PanelAppColor" style = "font-weight: bold;">{{login}}</div>
            <div *ngIf = "!right.change" style = "float:right; color:#b5e498; font-size:20px;" title = "Режим просмотра"><i class="fas fa-eye"></i></div>
            <div *ngIf = "mode == 'Global'" style = "float:right; color:#b5e498; font-size:20px;" title = "global"><i class="fas fa-cloud"></i></div>
        </div>
    </div>
    <!-- Закрепленный заголовок -->
    <table *ngIf = "fastenHeaderProperties.scrollTop > 0" 
        class = "errorTable TableCreatorBorderColor"
        style = "position: absolute; left:0px;" 
        [style.top] = "fastenHeaderProperties.offsetTop + 'px'">
        <tbody>
            <tr>
                <th name = "clickArea" 
                    *ngIf = "lineNumbering.enable" 
                    class = "TableCreatorHeadColor TableCreatorHeadBColor"
                    [style.width] = "fastenHeaderProperties.number.width + 'px'" 
                    [style.height] = "fastenHeaderProperties.number.height + 'px'"></th>
                <ng-container *ngFor = "let head of dataHeader">
                    <th *ngIf = "head"
                        name = "clickArea"  
                        class = "TableCreatorHeadColor TableCreatorHeadBColor" 
                        id = "{{ head.id }}"
                        [style.width] = "head.width + 'px'" 
                        [style.height] = "head.height + 'px'"
                        (contextmenu) = "getContextmenu($event, i, 'head')">
                        {{ head.name }}
                        <div class="linkClass">
                            <span *ngIf = "head.dataType == 'NUMBER'" class = "linkValueClass" style = "padding-left: 3px; padding-right: 4px;">123</span>
                            <span *ngIf = "head.dataType == 'STRING'" class = "linkValueClass" style = "padding-left: 2px; padding-right: 2px;">str</span>
                            <span *ngIf = "head.dataType == 'DATETIME'" class = "linkValueClass">
                                <i class="fas fa-clock"></i>
                            </span>
                            <span *ngIf = "head.dataType == 'tlist'" class = "linkValueClass">
                                <i class="fas fa-bars"></i>
                            </span>
                            <span *ngIf = "head.eventId" class = "linkCellClass">
                                <i class = "fa fa-bolt"></i>
                            </span>
                        </div>
                    </th>
                </ng-container>
            </tr>
        </tbody>
    </table>
    <!--  -->
</div>
<div class = "createContextMenu" 
    [hidden] = "!createContextMenu.visible" 
    [style.top] = "createContextMenu.top" 
    [style.left] = "createContextMenu.left"
    [style.transform] = "createContextMenu.transform">
    <ng-container *ngIf = "createContextMenu.type == 'head'">
        <ng-container *ngIf = "right.change && right.head">
            <button class = "contextMenuList" (click) = "pasteObject(true, false)" [disabled] = "!rules.type">Назначить тип</button>
            <button class = "contextMenuList" (click) = "pasteObject(true, 'NUMBER')" [disabled] = "!rules.change">Назначить тип NUMBER</button>
            <button class = "contextMenuList" (click) = "pasteObject(true, 'STRING')" [disabled] = "!rules.change">Назначить тип STRING</button>
            <button class = "contextMenuList" (click) = "pasteObject(true, 'DATETIME')" [disabled] = "!rules.change">Назначить тип DATETIME</button>
            <button class = "contextMenuList" (click) = "pasteObject(rules.event, false)" [disabled] = "!rules.object">
                    {{ rules.event ? 'Добавить событие' : 'Вставить объект' }}</button>
            <button *ngIf = "inputProperty.eventId" class = "contextMenuList" (click) = "removeEvent(true)" [disabled] = "!rules.change">Удалить событие</button>
            <button *ngIf = "inputProperty.eventId" class = "contextMenuList" (click) = "openEventToExplorer(inputProperty.eventId)">Найти событие</button>
            <button *ngIf = "inputProperty.eventId" class = "contextMenuList" (click) = "openSoftware('event', inputProperty.eventId)">Открыть событие</button>
        </ng-container>
        <button class = "contextMenuList" (click) = "clearFilters()">Очистить фильтры</button>
    </ng-container>
    <ng-container *ngIf = "createContextMenu.type == 'row'">
        <button class = "contextMenuList" (click) = "removeRow()" [disabled] = "!rules.change">Удалить строку</button>
        <button class = "contextMenuList" (click) = "cutCopyRow('copy')" [disabled] = "!rules.change">Копировать строку</button>
        <button class = "contextMenuList" (click) = "cutCopyRow('cut')" [disabled] = "!rules.change">Вырезать строку</button>
        <button class = "contextMenuList" (click) = "addCutRow(-1)" [disabled] = "cutCopyRowProperty.idRow1 < 0">Вставить выше</button>
        <button class = "contextMenuList" (click) = "addCutRow(1)" [disabled] = "cutCopyRowProperty.idRow1 < 0">Вставить ниже</button>
        <button class = "contextMenuList" (click) = "addRow('', -1)" [disabled] = "!rules.change">Вставить строку выше</button>
        <button class = "contextMenuList" (click) = "addRow('', 1)" [disabled] = "!rules.change">Вставить строку ниже</button>
    </ng-container>
    <ng-container *ngIf = "createContextMenu.type == 'cell'">
        <button class = "contextMenuList" (click) = "clearField()" [disabled] = "!rules.change">Очистить</button>
        <button class = "contextMenuList" (click) = "pasteObject(false, false)" [disabled] = "!rules.object">
                {{ rules.event ? 'Добавить событие' : 'Вставить объект' }}</button>
        <button class = "contextMenuList" (click) = "pasteField('cell')" [disabled] = "!rules.paste">Вставить по ссылке</button>
        <button class = "contextMenuList" (click) = "pasteField('value')" [disabled] = "!rules.paste">Вставить по значению</button>
        <button class = "contextMenuList" (click) = "copyField('copy')" [disabled] = "!rules.copy">Копировать</button>
        <button class = "contextMenuList" (click) = "copyField('cut')" [disabled] = "!rules.cut">Вырезать</button>
        <button class = "contextMenuList" [disabled] = "!rules.change">Статус 
            <span (click) = "setState(0)" style = "margin-left:5px;">0%</span>
            <span (click) = "setState(10)" style = "margin-left:5px;">10%</span>
            <span (click) = "setState(50)" style = "margin-left:5px;">50%</span>
            <span (click) = "setState(100)" style = "margin-left:5px;">100%</span>
        </button>
        <button *ngIf = "inputProperty.eventId" class = "contextMenuList" (click) = "removeEvent()" [disabled] = "!rules.change">Удалить событие</button>
        <button *ngIf = "inputProperty.eventId" class = "contextMenuList" (click) = "openEventToExplorer(inputProperty.eventId)">Найти событие</button>
        <button *ngIf = "inputProperty.eventId" class = "contextMenuList" (click) = "openSoftware('event', inputProperty.eventId)">Открыть событие</button>
        <button *ngIf = "inputProperty.type == 'cell'" class = "contextMenuList" (click) = "openToExplorer(inputProperty)">Найти в таблице</button>
        <button *ngIf = "inputProperty.type == 'table' || inputProperty.type == 'file' || inputProperty.type == 'tlist'" class = "contextMenuList" (click) = "openToExplorer(inputProperty)">Найти в проводнике</button>
        <button *ngIf = "inputProperty.type == 'table'" class = "contextMenuList" (click) = "openSoftware('table', inputProperty.linkId)">Открыть таблицу</button>
    </ng-container>
</div>
<modalwindow #modal></modalwindow>
<modal-moved-window #modalMovedWindow></modal-moved-window>